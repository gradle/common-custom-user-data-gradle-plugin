name: CCUD cross-version compatibility test

on:
  workflow_dispatch:
    inputs:
      ccud-version:
        required: true
        type: string
      

jobs:
  dv-plugins:
    strategy:
      fail-fast: false
      matrix:
        ccud-plugin-version: ${{ fromJSON(format('[ ''{0}'' ]', inputs.ccud-version)) }}
        dv-plugin-version: ["3.18.2", "3.17.6"]
        gradle-version: [8, 5]
        include:
        - expect-failure: false
    uses: ./.github/workflows/compatibility-check-single-version.yml
    with:
      gradle-version: ${{ matrix.gradle-version }}
      apply-plugin-script: |
          find . -type f -name "*.gradle" -exec sed -i '/id "com.gradle.develocity" version "3.18.2"/s/.*/id "com.gradle.develocity" version "${{ matrix.dv-plugin-version }}"\nid "com.gradle.common-custom-user-data-gradle-plugin" version "${{ matrix.ccud-plugin-version }}"/' {} +
      expect-failure: ${{ matrix.expect-failure }}
    secrets: inherit

  ge-3x-plugins:
    strategy:
      fail-fast: false
      matrix:
        ccud-plugin-version: ${{ fromJSON(format('[ ''{0}'' ]', inputs.ccud-version)) }}
        ge-plugin-version: ["3.18.2", "3.17.6", "3.16.2", "3.15.1", "3.14.1", "3.13.4", "3.12.6", "3.11.4", "3.10.3", "3.9", "3.8.1", "3.7.2", "3.6.4", "3.5.2", "3.4.1", "3.3.4", "3.2.1", "3.1.1", "3.0"]
        gradle-version: [8, 5]
        include:
          - expect-failure: false
    uses: ./.github/workflows/compatibility-check-single-version.yml
    with:
      gradle-version: ${{ matrix.gradle-version }}
      apply-plugin-script: |
          find . -type f -name "settings.gradle" -exec sed -i '/id "com.gradle.develocity" version "3.18.2"/s/.*/id "com.gradle.enterprise" version "${{ matrix.ge-plugin-version }}"\nid "com.gradle.common-custom-user-data-gradle-plugin" version "${{ matrix.ccud-plugin-version }}"/' {} +
          find . -type f -name "build.gradle" -exec sed -i '/id "com.gradle.develocity" version "3.18.2"/s/.*/id "com.gradle.build-scan" version "${{ matrix.ge-plugin-version }}"\nid "com.gradle.common-custom-user-data-gradle-plugin" version "${{ matrix.ccud-plugin-version }}"/' {} +
          find . -type f -name "*.gradle" -exec sed -i '/develocity {/s/.*/gradleEnterprise {\n  buildScan { publishAlways() }/' {} +
      expect-failure: ${{ matrix.expect-failure }}
    secrets: inherit

  bs-2x-plugins:
    strategy:
      fail-fast: false
      matrix:
        ccud-plugin-version: ${{ fromJSON(format('[ ''{0}'' ]', inputs.ccud-version)) }}
        bs-plugin-version: ["2.4.2", "2.3", "2.2.1", "2.1", "2.0.2"]
        gradle-version: [5]
        include:
          - expect-failure: false
    uses: ./.github/workflows/compatibility-check-single-version.yml
    with:
      gradle-version: ${{ matrix.gradle-version }}
      apply-plugin-script: |
          find . -type f -name "build.gradle" -exec sed -i '/id "com.gradle.develocity" version "3.18.2"/s/.*/id "com.gradle.build-scan" version "${{ matrix.bs-plugin-version }}"\nid "com.gradle.common-custom-user-data-gradle-plugin" version "${{ matrix.ccud-plugin-version }}"/' {} +
          find . -type f -name "*.gradle" -exec sed -i '/develocity {/s/.*/gradleEnterprise {\n  buildScan { publishAlways() }/' {} +
      expect-failure: ${{ matrix.expect-failure }}
    secrets: inherit

  bs-1x-plugins:
    strategy:
      fail-fast: false
      matrix:
        ccud-plugin-version: ${{ fromJSON(format('[ ''{0}'' ]', inputs.ccud-version)) }}
        build-scan-plugin-version: ["1.16", "1.15.2", "1.14", "1.13.4", "1.12.1", "1.11", "1.10.3", "1.9.1", "1.8"]
        gradle-version: [4]
        include:
          - expect-failure: false
    uses: ./.github/workflows/compatibility-check-single-version.yml
    with:
      gradle-version: ${{ matrix.gradle-version }}
      apply-plugin-script: |
          find . -type f -name "build.gradle" -exec sed -i '/id "com.gradle.build-scan" version "1.16"/s/.*/id "com.gradle.build-scan" version "${{ matrix.build-scan-plugin-version }}"\nid "com.gradle.common-custom-user-data-gradle-plugin" version "${{ matrix.ccud-plugin-version }}"/' {} +
          find . -type f -name "build.gradle" -exec sed -i '/server = "https:\/\/ge.solutions-team.gradle.com"/s/.*/termsOfServiceUrl = "https:\/\/gradle.com\/terms-of-service"\ntermsOfServiceAgree = "yes"/' {} +
      expect-failure: ${{ matrix.expect-failure }}
    secrets: inherit
